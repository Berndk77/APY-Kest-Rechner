<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b6efd">
  <title>APY & KESt Rechner</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b6efd;
      --bg-2:#f7f9fc;
      --text:#0f172a;
      --muted:#6b7280;
      --card:#ffffff;
      --ok:#0ea5e9;
      --accent:#22c55e;
      --danger:#ef4444;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color:var(--text);
      background:linear-gradient(180deg, var(--bg) 0 180px, var(--bg-2) 180px 100%);
      min-height:100vh;
    }
    header{
      padding:28px 16px 20px;
      color:white;
      text-align:center;
    }
    header h1{
      margin:0 0 6px;
      font-size: clamp(20px, 4.5vw, 28px);
      font-weight:700;
      letter-spacing:.2px;
    }
    header p{margin:0;opacity:.9}
    main{
      max-width:980px;margin:-60px auto 40px;padding:0 16px;
    }
    .card{
      background:var(--card);
      border-radius:14px;
      box-shadow: 0 10px 30px rgba(2,6,23,.15);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
    }
    @media (min-width: 880px){
      .grid{ grid-template-columns: 1.05fr .95fr; }
      .side{ border-left:1px solid var(--border); }
    }
    .section{
      padding:18px;
    }
    .section h2{
      margin:0 0 12px;
      font-size: 18px;
    }
    .row{
      display:flex;gap:12px;align-items:center;margin:10px 0;
    }
    label{font-size:14px;color:var(--muted);}
    input, select{
      flex:1;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      outline:none;
      font-size:16px;
      transition:border .15s ease, box-shadow .15s ease;
      background:#fff;
    }
    input:focus, select:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35) }
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .btn{
      appearance:none;border:0;border-radius:10px;padding:12px 16px;
      background:var(--bg);color:#fff;font-weight:600;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.secondary{background:#111827}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .results{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;
    }
    .kpi{
      padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;
    }
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:20px;font-weight:700;margin-top:2px}
    .kpi .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .rows{margin-top:8px;border-top:1px dashed var(--border);padding-top:8px}
    .milestones{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .milestones .kpi .value{font-size:16px}
    footer{padding:18px;text-align:center;color:#334155;font-size:12px}
    .switch{
      display:inline-flex;align-items:center;gap:10px
    }
    .switch input{width:auto}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#1f2937;background:#fff;
    }
    .sep{height:1px;background:var(--border);margin:12px 0}
    .table-wrap{max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th, td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child, td:first-child{text-align:left}
    tr:nth-child(even){background:#fafafa}
  </style>
</head>
<body>
  <header>
    <h1>APY & KESt Rechner (Web-App)</h1>
    <p>Täglicher Zinseszins aus APY • Netto optional mit KESt • CSV-Export • Offline nutzbar</p>
  </header>

  <main>
    <div class="card grid">
      <div class="section">
        <h2>Eingaben</h2>

        <div class="row">
          <label for="principal" style="min-width:150px">Startkapital (€)</label>
          <input id="principal" inputmode="decimal" value="10000" autocomplete="off">
        </div>

        <div class="row">
          <label for="apy" style="min-width:150px">APY (% p.a.)</label>
          <input id="apy" inputmode="decimal" value="15" autocomplete="off">
        </div>

        <div class="row">
          <label for="years" style="min-width:150px">Laufzeit (Jahre)</label>
          <select id="years">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>

        <div class="row" style="justify-content:space-between">
          <div class="switch">
            <input type="checkbox" id="withTax" checked>
            <label for="withTax">KESt berücksichtigen</label>
          </div>
          <div class="row" style="margin:0">
            <label for="kest" style="min-width:110px">KESt (%)</label>
            <input id="kest" inputmode="decimal" value="27.5" autocomplete="off" style="width:120px">
          </div>
        </div>

        <div class="hint">Tageszins wird aus APY berechnet: r<sub>Tag</sub> = (1 + APY)<sup>1/365</sup> − 1</div>

        <div class="top-actions">
          <button class="btn" id="calcBtn">Berechnen</button>
          <button class="btn ghost" id="csvBtn">CSV (365 Tage)</button>
          <span class="badge" id="dailyRateBadge">Tageszins: —</span>
        </div>

        <div class="sep"></div>

        <h2>Ergebnis</h2>
        <div class="results">
          <div class="kpi">
            <div class="label">Endbetrag (brutto)</div>
            <div class="value" id="grossEnd">—</div>
            <div class="sub" id="grossInt">Zinsen brutto: —</div>
          </div>
          <div class="kpi">
            <div class="label">Endbetrag (netto)</div>
            <div class="value" id="netEnd">—</div>
            <div class="sub" id="netInt">Zinsen netto: —</div>
          </div>
          <div class="kpi">
            <div class="label">Abzug KESt</div>
            <div class="value" id="tax">—</div>
            <div class="sub">am Periodenende</div>
          </div>
          <div class="kpi">
            <div class="label">Effektiver Nettozins p.a.</div>
            <div class="value" id="effNet">—</div>
            <div class="sub">nach Steuer</div>
          </div>
        </div>

        <div class="rows">
          <h2>Meilensteine (netto, ca.)</h2>
          <div class="milestones">
            <div class="kpi">
              <div class="label">Tag 30</div>
              <div class="value" id="m30">—</div>
            </div>
            <div class="kpi">
              <div class="label">Tag 90</div>
              <div class="value" id="m90">—</div>
            </div>
            <div class="kpi">
              <div class="label">Tag 180</div>
              <div class="value" id="m180">—</div>
            </div>
            <div class="kpi">
              <div class="label">Tag 270</div>
              <div class="value" id="m270">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="section side">
        <h2>365‑Tage‑Tabelle (brutto & netto)</h2>
        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th>Tag</th>
                <th>Kontostand (brutto)</th>
                <th>Zinsen kum. (brutto)</th>
                <th>Schätzung netto*</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint">* Netto-Schätzung geht davon aus, dass KESt am Periodenende fällig wird.</div>
      </div>
    </div>
  </main>

  <footer>
    <div>Made for Bernd • Läuft offline (zum Home-Bildschirm hinzufügen) • APY → täglicher Zinseszins</div>
  </footer>

  <script>
    // Helpers
    const nfEUR = new Intl.NumberFormat('de-AT', { style:'currency', currency:'EUR', maximumFractionDigits:2 });
    const nfPct = new Intl.NumberFormat('de-AT', { style:'percent', maximumFractionDigits:5 });

    const el = id => document.getElementById(id);

    function parseNum(x){
      if (typeof x !== 'string') return 0;
      x = x.replace(/\./g,'').replace(',', '.').trim();
      const v = Number(x);
      return Number.isFinite(v) ? v : 0;
    }

    function calc(){
      const P = parseNum(el('principal').value);
      const apyPct = parseNum(el('apy').value);
      const years = Number(el('years').value);
      const withTax = el('withTax').checked;
      const kestPct = parseNum(el('kest').value);

      const apy = apyPct / 100;
      const kest = kestPct / 100;
      const days = Math.round(365 * years);

      // daily rate from APY
      const rDaily = Math.pow(1 + apy, 1/365) - 1;

      el('dailyRateBadge').textContent = `Tageszins: ${nfPct.format(rDaily)}`;

      // Endwert brutto (APY bereits inkl. Zinseszins)
      const grossEnd = P * Math.pow(1 + apy, years);
      const grossInt = Math.max(0, grossEnd - P);
      const tax = withTax ? grossInt * kest : 0;
      const netInt = grossInt - tax;
      const netEnd = P + netInt;

      el('grossEnd').textContent = nfEUR.format(grossEnd);
      el('grossInt').textContent = `Zinsen brutto: ${nfEUR.format(grossInt)}`;
      el('tax').textContent = withTax ? nfEUR.format(tax) : '—';
      el('netInt').textContent = withTax ? `Zinsen netto: ${nfEUR.format(netInt)}` : 'Zinsen netto: —';
      el('netEnd').textContent = withTax ? nfEUR.format(netEnd) : '—';

      const effNetRate = withTax ? apy * (1 - kest) : null;
      el('effNet').textContent = withTax ? new Intl.NumberFormat('de-AT', { style:'percent', maximumFractionDigits:3 }).format(effNetRate) : '—';

      // Table (daily)
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      let balance = P;
      for(let d=1; d<=Math.min(365, days); d++){
        balance = balance * (1 + rDaily);
        const brutto = balance;
        const bruttoInt = brutto - P;
        const estNet = withTax ? P + bruttoInt * (1 - kest) : brutto; // proportionally applying tax at the end
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d}</td>
                        <td>${nfEUR.format(brutto)}</td>
                        <td>${nfEUR.format(bruttoInt)}</td>
                        <td>${nfEUR.format(estNet)}</td>`;
        tbody.appendChild(tr);
      }

      // Milestones (net estimate)
      const getEstNet = (d)=>{
        let b = P * Math.pow(1 + rDaily, d);
        let gi = b - P;
        return withTax ? P + gi * (1 - kest) : b;
      };
      el('m30').textContent = nfEUR.format(getEstNet(30));
      el('m90').textContent = nfEUR.format(getEstNet(90));
      el('m180').textContent = nfEUR.format(getEstNet(180));
      el('m270').textContent = nfEUR.format(getEstNet(270));
    }

    function exportCSV(){
      const P = parseNum(el('principal').value);
      const apyPct = parseNum(el('apy').value);
      const years = Number(el('years').value);
      const withTax = el('withTax').checked;
      const kestPct = parseNum(el('kest').value);

      const apy = apyPct / 100;
      const kest = kestPct / 100;
      const rDaily = Math.pow(1 + apy, 1/365) - 1;

      let csv = 'Tag;Kontostand (brutto);Zinsen kum. (brutto);Schätzung netto\\n';
      let balance = P;
      for(let d=1; d<=365; d++){
        balance = balance * (1 + rDaily);
        const brutto = balance;
        const bruttoInt = brutto - P;
        const estNet = withTax ? P + bruttoInt * (1 - kest) : brutto;
        csv += `${d};${brutto.toFixed(2).replace('.',',')};${bruttoInt.toFixed(2).replace('.',',')};${estNet.toFixed(2).replace('.',',')}\\n`;
      }
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'apy_kest_365_tage.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    el('calcBtn').addEventListener('click', calc);
    el('csvBtn').addEventListener('click', exportCSV);

    // Auto-calc on load
    window.addEventListener('load', ()=>{
      calc();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
    });
  </script>
</body>
</html>
