<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b6efd">
  <title>APY & KESt Rechner</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b6efd;
      --bg-2:#f7f9fc;
      --text:#0f172a;
      --muted:#475569;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{overflow-x:hidden}
    body{
      margin:0;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:linear-gradient(180deg, var(--bg) 0 160px, var(--bg-2) 160px 100%);
    }
    .page{
      /* Safe areas for iOS notch and edges */
      padding-top: calc(env(safe-area-inset-top) + 8px);
      padding-left: calc(env(safe-area-inset-left) + 12px);
      padding-right: calc(env(safe-area-inset-right) + 12px);
      padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
    }
    header{
      padding:24px 8px 16px;
      color:#fff;
      text-align:center;
    }
    header h1{
      margin:0 0 6px;
      font-size: clamp(18px, 4.2vw, 26px);
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.15;
      text-wrap:balance;
    }
    header p{margin:0;opacity:.95;font-size:14px}
    main{
      max-width:980px;
      margin: 12px auto 28px;
      padding: 0 4px;
    }
    .card{
      background:var(--card);
      border-radius:14px;
      box-shadow: 0 8px 26px rgba(2,6,23,.12);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .grid{ display:grid; grid-template-columns: 1fr; }
    @media (min-width: 920px){
      .grid{ grid-template-columns: 1.05fr .95fr; }
      .side{ border-left:1px solid var(--border); }
    }
    .section{ padding:16px }
    .section h2{ margin:0 0 10px; font-size: 17px; }
    .row{ display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap }
    label.field{ font-size:14px; color:var(--muted); min-width:150px }
    input, select{
      flex:1; min-height:44px; padding:10px 12px;
      border:1px solid var(--border); border-radius:12px;
      font-size:16px; background:#fff; outline:none;
      -webkit-appearance:none; appearance:none;
    }
    input:focus, select:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(147,197,253,.35) }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
    .btn{
      border:0; border-radius:12px; padding:12px 16px;
      background:#0b6efd; color:#fff; font-weight:700; cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn.ghost{ background:#fff; color:#111827; border:1px solid var(--border) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .top-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border); border-radius:999px;
      padding:6px 10px; font-size:12px; color:#1f2937; background:#fff;
    }
    .sep{ height:1px; background:var(--border); margin:12px 0 }
    .results{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    @media (max-width: 480px){ .results{ grid-template-columns:1fr; } }
    .kpi{ padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff }
    .kpi .label{ font-size:12px; color:var(--muted) }
    .kpi .value{ font-size:20px; font-weight:800; margin-top:2px; line-height:1.2; word-break:break-word }
    .kpi .sub{ font-size:12px; color:var(--muted); margin-top:2px }
    .rows{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .milestones{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
    .milestones .kpi .value{ font-size:16px }
    .table-wrap{
      border:1px solid var(--border); border-radius:12px;
      overflow:auto; -webkit-overflow-scrolling:touch; max-height:320px;
      background:#fff;
    }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:520px }
    th, td{ padding:10px; border-bottom:1px solid var(--border); text-align:right; white-space:nowrap }
    th:first-child, td:first-child{ text-align:left }
    tr:nth-child(even){ background:#fafafa }
    footer{ padding:16px; text-align:center; color:#334155; font-size:12px }

    /* Big, always-clickable toggle */
    .toggle{
      display:flex; align-items:center; gap:10px; user-select:none; -webkit-user-select:none;
      padding:6px 0;
    }
    .toggle input{ position:absolute; opacity:0; width:1px; height:1px; }
    .slider{
      position:relative; width:52px; height:32px; border-radius:999px;
      background:#e5e7eb; border:1px solid #d1d5db; flex:0 0 auto;
      transition:background .2s ease, border .2s ease;
    }
    .slider::after{
      content:""; position:absolute; top:50%; left:3px; transform:translateY(-50%);
      width:26px; height:26px; border-radius:50%; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.15);
      transition:left .2s ease;
    }
    .toggle input:checked + .slider{
      background:#0b6efd; border-color:#0b6efd;
    }
    .toggle input:checked + .slider::after{
      left:23px;
    }
    .toggle .tlabel{ font-size:14px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>APY & KESt Rechner (Web-App)</h1>
      <p>Täglicher Zinseszins • Netto optional mit KESt • CSV-Export • Offline nutzbar</p>
    </header>

    <main>
      <div class="card grid">
        <div class="section">
          <h2>Eingaben</h2>

          <div class="row">
            <label class="field" for="principal">Startkapital (€)</label>
            <input id="principal" inputmode="decimal" value="10000" autocomplete="off">
          </div>

          <div class="row">
            <label class="field" for="apy">APY (% p.a.)</label>
            <input id="apy" inputmode="decimal" value="15" autocomplete="off">
          </div>

          <div class="row">
            <label class="field" for="years">Laufzeit (Jahre)</label>
            <select id="years">
              <option value="1" selected>1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="10">10</option>
            </select>
          </div>

          <div class="row" style="justify-content:space-between;gap:12px">
            <label class="toggle">
              <input type="checkbox" id="withTax" checked>
              <span class="slider" aria-hidden="true"></span>
              <span class="tlabel">KESt berücksichtigen</span>
            </label>
            <div class="row" style="margin:0;flex:0 0 auto">
              <label class="field" for="kest" style="min-width:auto">KESt (%)</label>
              <input id="kest" inputmode="decimal" value="27.5" autocomplete="off" style="width:120px">
            </div>
          </div>

          <div class="hint">Tageszins wird aus APY berechnet: r<sub>Tag</sub> = (1 + APY)<sup>1/365</sup> − 1</div>

          <div class="top-actions">
            <button class="btn" id="calcBtn">Berechnen</button>
            <button class="btn ghost" id="csvBtn">CSV (365 Tage)</button>
            <span class="badge" id="dailyRateBadge">Tageszins: —</span>
          </div>

          <div class="sep"></div>

          <h2>Ergebnis</h2>
          <div class="results">
            <div class="kpi">
              <div class="label">Endbetrag (brutto)</div>
              <div class="value" id="grossEnd">—</div>
              <div class="sub" id="grossInt">Zinsen brutto: —</div>
            </div>
            <div class="kpi">
              <div class="label">Endbetrag (netto)</div>
              <div class="value" id="netEnd">—</div>
              <div class="sub" id="netInt">Zinsen netto: —</div>
            </div>
            <div class="kpi">
              <div class="label">Abzug KESt</div>
              <div class="value" id="tax">—</div>
              <div class="sub">am Periodenende</div>
            </div>
            <div class="kpi">
              <div class="label">Effektiver Nettozins p.a.</div>
              <div class="value" id="effNet">—</div>
              <div class="sub">nach Steuer</div>
            </div>
          </div>

          <div class="rows">
            <h2>Meilensteine (netto, ca.)</h2>
            <div class="milestones">
              <div class="kpi">
                <div class="label">Tag 30</div>
                <div class="value" id="m30">—</div>
              </div>
              <div class="kpi">
                <div class="label">Tag 90</div>
                <div class="value" id="m90">—</div>
              </div>
              <div class="kpi">
                <div class="label">Tag 180</div>
                <div class="value" id="m180">—</div>
              </div>
              <div class="kpi">
                <div class="label">Tag 270</div>
                <div class="value" id="m270">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section side">
          <h2>365-Tage-Tabelle (brutto & netto)</h2>
          <div class="table-wrap">
            <table id="table">
              <thead>
                <tr>
                  <th>Tag</th>
                  <th>Kontostand (brutto)</th>
                  <th>Zinsen kum. (brutto)</th>
                  <th>Schätzung netto*</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="hint">* Netto-Schätzung geht davon aus, dass KESt am Periodenende fällig wird.</div>
        </div>
      </div>
    </main>

    <footer>
      <div>Made for Bernd • PWA mit Safe-Area • APY → täglicher Zinseszins</div>
    </footer>
  </div>

  <script>
    // Helpers
    const nfEUR = new Intl.NumberFormat('de-AT', { style:'currency', currency:'EUR', maximumFractionDigits:2 });
    const nfPct = new Intl.NumberFormat('de-AT', { style:'percent', maximumFractionDigits:5 });
    const el = id => document.getElementById(id);

    function parseNum(x){
      if (typeof x !== 'string') return 0;
      x = x.replace(/\./g,'').replace(',', '.').trim();
      const v = Number(x);
      return Number.isFinite(v) ? v : 0;
    }

    function calc(){
      const P = parseNum(el('principal').value);
      const apyPct = parseNum(el('apy').value);
      const years = Number(el('years').value);
      const withTax = document.getElementById('withTax').checked;
      const kestPct = parseNum(document.getElementById('kest').value);

      const apy = apyPct / 100;
      const kest = kestPct / 100;

      // daily rate from APY
      const rDaily = Math.pow(1 + apy, 1/365) - 1;
      document.getElementById('dailyRateBadge').textContent = `Tageszins: ${nfPct.format(rDaily)}`;

      // Endwert brutto (APY inkl. Zinseszins, daher ^years)
      const grossEnd = P * Math.pow(1 + apy, years);
      const grossInt = Math.max(0, grossEnd - P);
      const tax = withTax ? grossInt * kest : 0;
      const netInt = grossInt - tax;
      const netEnd = P + netInt;

      document.getElementById('grossEnd').textContent = nfEUR.format(grossEnd);
      document.getElementById('grossInt').textContent = `Zinsen brutto: ${nfEUR.format(grossInt)}`;
      document.getElementById('tax').textContent = withTax ? nfEUR.format(tax) : '—';
      document.getElementById('netInt').textContent = withTax ? `Zinsen netto: ${nfEUR.format(netInt)}` : 'Zinsen netto: —';
      document.getElementById('netEnd').textContent = withTax ? nfEUR.format(netEnd) : '—';

      const effNetRate = withTax ? apy * (1 - kest) : null;
      document.getElementById('effNet').textContent = withTax ? new Intl.NumberFormat('de-AT', { style:'percent', maximumFractionDigits:3 }).format(effNetRate) : '—';

      // Table (daily, 365 Tage Vorschau)
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      let balance = P;
      for(let d=1; d<=365; d++){
        balance = balance * (1 + rDaily);
        const brutto = balance;
        const bruttoInt = brutto - P;
        const estNet = withTax ? P + bruttoInt * (1 - kest) : brutto; // Steuer erst am Periodenende angenähert
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d}</td>
                        <td>${nfEUR.format(brutto)}</td>
                        <td>${nfEUR.format(bruttoInt)}</td>
                        <td>${nfEUR.format(estNet)}</td>`;
        tbody.appendChild(tr);
      }

      // Milestones (net estimate)
      const getEstNet = (d)=>{
        let b = P * Math.pow(1 + rDaily, d);
        let gi = b - P;
        return withTax ? P + gi * (1 - kest) : b;
      };
      document.getElementById('m30').textContent = nfEUR.format(getEstNet(30));
      document.getElementById('m90').textContent = nfEUR.format(getEstNet(90));
      document.getElementById('m180').textContent = nfEUR.format(getEstNet(180));
      document.getElementById('m270').textContent = nfEUR.format(getEstNet(270));
    }

    function exportCSV(){
      const P = parseNum(el('principal').value);
      const apyPct = parseNum(el('apy').value);
      const withTax = document.getElementById('withTax').checked;
      const kestPct = parseNum(document.getElementById('kest').value);
      const apy = apyPct / 100;
      const kest = kestPct / 100;
      const rDaily = Math.pow(1 + apy, 1/365) - 1;

      let csv = 'Tag;Kontostand (brutto);Zinsen kum. (brutto);Schätzung netto\\n';
      let balance = P;
      for(let d=1; d<=365; d++){
        balance = balance * (1 + rDaily);
        const brutto = balance;
        const bruttoInt = brutto - P;
        const estNet = withTax ? P + bruttoInt * (1 - kest) : brutto;
        csv += `${d};${brutto.toFixed(2).replace('.',',')};${bruttoInt.toFixed(2).replace('.',',')};${estNet.toFixed(2).replace('.',',')}\\n`;
      }
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'apy_kest_365_tage.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener('click', (e)=>{
      // make the whole toggle area clickable
      const toggle = e.target.closest('.toggle');
      if (toggle){
        const input = toggle.querySelector('input[type="checkbox"]');
        if (e.target !== input){
          input.checked = !input.checked;
          calc();
        }
      }
    });

    document.getElementById('calcBtn').addEventListener('click', calc);
    document.getElementById('csvBtn').addEventListener('click', exportCSV);

    // Auto-calc on load
    window.addEventListener('load', ()=>{
      calc();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
    });
  </script>
</body>
</html>
